# CLAUDE.md

This file provides guidance to [Claude Code](https://claude.ai/code) when working with code in this repository.

## Project Overview

AuthGate is an OAuth 2.0 Device Authorization Grant (RFC 8628) server built with Go and Gin. It enables CLI tools to authenticate users without embedding client secrets.

## Common Commands

```bash
# Build
make build              # Build to bin/authgate with version info in LDFLAGS

# Run
./bin/authgate -v       # Show version information
./bin/authgate -h       # Show help
./bin/authgate server   # Start the OAuth server

# Test & Lint
make test               # Run tests with coverage report (outputs coverage.txt)
make lint               # Run golangci-lint (auto-installs if missing)
make fmt                # Format code with golangci-lint fmt

# Cross-compile (outputs to release/<os>/<arch>/)
make build_linux_amd64  # CGO_ENABLED=0 for static binary
make build_linux_arm64  # CGO_ENABLED=0 for static binary

# Clean
make clean              # Remove bin/, release/, coverage.txt

# Docker
docker build -f docker/Dockerfile -t authgate .
```

## Architecture

**Device Authorization Flow**:

1. CLI calls `POST /oauth/device/code` with client_id → receives device_code + user_code + verification_uri
2. User visits verification_uri (`/device`) in browser, must login first if not authenticated
3. User submits user_code via `POST /device/verify` → device code marked as authorized
4. CLI polls `POST /oauth/token` with device_code every 5s → receives JWT when authorized

**Layers** (dependency injection pattern):

- `main.go` - Wires up store → services → handlers, configures Gin router with session middleware
- `config/` - Loads .env via godotenv, provides Config struct with defaults
- `store/` - GORM-based data access layer with SQLite, single Store struct with all DB methods
- `services/` - Business logic (UserService, DeviceService, TokenService), depends on Store
- `handlers/` - HTTP handlers (AuthHandler, DeviceHandler, TokenHandler), depends on Services
- `models/` - GORM models (User, OAuthClient, DeviceCode, AccessToken)
- `middleware/` - Gin middleware (auth.go: RequireAuth checks session for user_id)

**Key Implementation Details**:

- Device codes expire after 30min (configurable via Config.DeviceCodeExpiration)
- User codes are 8-char uppercase alphanumeric (generated by generateUserCode in services/device.go)
- User codes normalized: uppercase + dashes removed before lookup
- JWTs signed with HMAC-SHA256, expire after 1 hour (Config.JWTExpiration)
- Sessions stored in encrypted cookies (gin-contrib/sessions), 7-day expiry
- Polling interval is 5 seconds (Config.PollingInterval)
- Templates and static files embedded via go:embed in main.go

**Key Endpoints**:

- `GET /health` - Health check with database connection test
- `POST /oauth/device/code` - CLI requests device+user codes (accepts form or JSON)
- `POST /oauth/token` - CLI polls for JWT (grant_type=urn:ietf:params:oauth:grant-type:device_code)
- `GET /oauth/tokeninfo` - Verify JWT validity
- `GET /device` - User authorization page (protected, requires login)
- `POST /device/verify` - User submits code to authorize device (protected)
- `GET|POST /login` - User authentication
- `GET /logout` - Clear session

**Error Handling**: Services return typed errors (ErrInvalidClient, ErrDeviceCodeNotFound, etc.), handlers convert to RFC 8628 OAuth error responses

## Environment Variables

| Variable       | Default                 | Description                     |
| -------------- | ----------------------- | ------------------------------- |
| SERVER_ADDR    | :8080                   | Listen address                  |
| BASE_URL       | `http://localhost:8080` | Public URL for verification_uri |
| JWT_SECRET     | (default)               | JWT signing key                 |
| SESSION_SECRET | (default)               | Cookie encryption key           |
| DATABASE_PATH  | oauth.db                | SQLite database path            |

## Default Test Data

Seeded automatically on first run (store/sqlite.go:seedData):

- User: `admin` / `<random_password>` (16-character random password, logged at startup, bcrypt hashed)
- Client: `AuthGate CLI` (client_id is auto-generated UUID, logged at startup)

## Example CLI Client

`_example/authgate-cli/` contains a demo CLI that demonstrates the device flow:

```bash
cd _example/authgate-cli
cp .env.example .env      # Add CLIENT_ID from server logs
go run main.go
```

## Coding Conventions

- Use `http.StatusOK`, `http.StatusBadRequest`, etc. instead of numeric status codes
- Services return typed errors, handlers convert to appropriate HTTP responses
- GORM models use `gorm.Model` for CreatedAt/UpdatedAt/DeletedAt
- Handlers accept both form-encoded and JSON request bodies where applicable
- All static assets and templates are embedded via `//go:embed` for single-binary deployment
- Database connection health check available via `store.Health()` method
- **IMPORTANT**: Before committing changes:
  1. Run `make fmt` to automatically fix code formatting issues
  2. Run `make lint` to verify all code passes linting without errors
